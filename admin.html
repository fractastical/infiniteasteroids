<!DOCTYPE html>
<html>

<head>
    <title>Admin Dashboard</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <h1>Admin Dashboard</h1>
    <div id="sessionInfo">
        <p>Total Sessions: <span id="totalSessions"></span></p>
        <p>Total Session Time: <span id="totalSessionTime"></span></p>
        <p>Average Session Time: <span id="averageSessionTime"></span></p>
    </div>
    <div id="topWeapons">
        <h2>Top Weapons Used</h2>
        <ol id="topWeaponsList"></ol>
    </div>
    <div id="topWeaponsHighScores">
        <h2>Top Weapons Used (Scores above 100,000)</h2>
        <ol id="topWeaponsHighScoresList"></ol>
    </div>
    <div id="topWeaponsUltraHighScores">
        <h2>Top Weapons Used (Scores above 500,000)</h2>
        <ol id="topWeaponsUltraHighScoresList"></ol>
    </div>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js"></script>
    <script>
        // Initialize Firebase (replace with your own config)
        const firebaseConfig = {
            apiKey: "AIzaSyCvgdn8c6D8RusKRr4vHAzFj1x4FNxrXVE",
            authDomain: "infinite-games-9c69e.firebaseapp.com",
            projectId: "infinite-games-9c69e",
            storageBucket: "infinite-games-9c69e.appspot.com",
            messagingSenderId: "602022483888",
            appId: "1:602022483888:web:f967a6c1cb236ae66ba875",
            measurementId: "G-9LE6E1BKZ7"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Function to calculate total session time in milliseconds
        function calculateTotalSessionTime(sessions) {
            return sessions.reduce((total, session) => {
                const sessionLength = parseFloat(session.sessionLength);
                return total + (isNaN(sessionLength) || sessionLength > 18000 * 1000 ? 0 : sessionLength);
            }, 0);
        }

        // Function to calculate average session time in milliseconds
        function calculateAverageSessionTime(totalSessionTime, totalSessions) {
            return totalSessions > 0 ? totalSessionTime / totalSessions : 0;
        }

        // Function to get the top weapons used by average damage done
        function getTopWeaponsUsed(sessions) {
            const weaponStats = {};

            sessions.forEach((session) => {
                if (session.topWeapons) {
                    session.topWeapons.forEach((weapon) => {
                        if (weaponStats[weapon.weapon]) {
                            weaponStats[weapon.weapon].totalDamage += weapon.damage;
                            weaponStats[weapon.weapon].count += 1;
                        } else {
                            weaponStats[weapon.weapon] = { totalDamage: weapon.damage, count: 1 };
                        }
                    });
                }
            });

            return Object.entries(weaponStats)
                .map(([weapon, stats]) => ({
                    weapon,
                    averageDamage: stats.totalDamage / stats.count,
                    count: stats.count
                }))
                .sort((a, b) => b.averageDamage - a.averageDamage);
        }

        // Function to get the top weapons used by average damage done for high scores
        function getTopWeaponsUsedHighScores(sessions, scoreThreshold) {
            const weaponStats = {};

            sessions.forEach((session) => {
                if (session.score > scoreThreshold && session.topWeapons) {
                    session.topWeapons.forEach((weapon) => {
                        if (weaponStats[weapon.weapon]) {
                            weaponStats[weapon.weapon].totalDamage += weapon.damage;
                            weaponStats[weapon.weapon].count += 1;
                        } else {
                            weaponStats[weapon.weapon] = { totalDamage: weapon.damage, count: 1 };
                        }
                    });
                }
            });

            return Object.entries(weaponStats)
                .map(([weapon, stats]) => ({
                    weapon,
                    averageDamage: stats.totalDamage / stats.count,
                    count: stats.count
                }))
                .sort((a, b) => b.averageDamage - a.averageDamage);
        }

        // Function to display the admin dashboard data
        function displayAdminData(totalSessions, totalSessionTime, averageSessionTime, topWeapons, topWeaponsHighScores, topWeaponsUltraHighScores) {
            document.getElementById('totalSessions').textContent = totalSessions;
            document.getElementById('totalSessionTime').textContent = formatTime(totalSessionTime);
            document.getElementById('averageSessionTime').textContent = formatTime(averageSessionTime);

            const topWeaponsList = document.getElementById('topWeaponsList');
            topWeapons.forEach((weapon) => {
                const listItem = document.createElement('li');
                listItem.textContent = `${weapon.weapon}: ${weapon.count} times, Average Damage: ${weapon.averageDamage.toFixed(2)}`;
                topWeaponsList.appendChild(listItem);
            });

            const topWeaponsHighScoresList = document.getElementById('topWeaponsHighScoresList');
            topWeaponsHighScores.forEach((weapon) => {
                const listItem = document.createElement('li');
                listItem.textContent = `${weapon.weapon}: ${weapon.count} times, Average Damage: ${weapon.averageDamage.toFixed(2)}`;
                topWeaponsHighScoresList.appendChild(listItem);
            });

            const topWeaponsUltraHighScoresList = document.getElementById('topWeaponsUltraHighScoresList');
            topWeaponsUltraHighScores.forEach((weapon) => {
                const listItem = document.createElement('li');
                listItem.textContent = `${weapon.weapon}: ${weapon.count} times, Average Damage: ${weapon.averageDamage.toFixed(2)}`;
                topWeaponsUltraHighScoresList.appendChild(listItem);
            });
        }

        // Function to format time in milliseconds to a readable format (hh:mm:ss)
        function formatTime(timeInMilliseconds) {
            const timeInSeconds = timeInMilliseconds / 1000;
            const hours = Math.floor(timeInSeconds / 3600);
            const minutes = Math.floor((timeInSeconds % 3600) / 60);
            const seconds = Math.floor(timeInSeconds % 60);

            return `${padZero(hours)}:${padZero(minutes)}:${padZero(seconds)}`;
        }

        // Function to pad single-digit numbers with leading zero
        function padZero(number) {
            return number.toString().padStart(2, '0');
        }

        // Fetch data from Firestore and display admin dashboard
        db.collection('users')
            .get()
            .then((querySnapshot) => {
                let totalSessions = 0;
                let totalSessionTime = 0;
                const allSessions = [];

                querySnapshot.forEach((doc) => {
                    const userData = doc.data();
                    const gameSessions = userData.games?.InfiniteSpaceWar?.scores || [];

                    // Filter out sessions longer than 5 hours (18000 seconds * 1000 milliseconds)
                    const validSessions = gameSessions.filter(session => parseFloat(session.sessionLength) <= 18000 * 1000);

                    totalSessions += validSessions.length;
                    totalSessionTime += calculateTotalSessionTime(validSessions);
                    allSessions.push(...validSessions);
                });

                const averageSessionTime = calculateAverageSessionTime(totalSessionTime, totalSessions);
                const topWeapons = getTopWeaponsUsed(allSessions);
                const topWeaponsHighScores = getTopWeaponsUsedHighScores(allSessions, 100000);
                const topWeaponsUltraHighScores = getTopWeaponsUsedHighScores(allSessions, 500000);

                displayAdminData(totalSessions, totalSessionTime, averageSessionTime, topWeapons, topWeaponsHighScores, topWeaponsUltraHighScores);
            })
            .catch((error) => {
                console.error('Error fetching admin data:', error);
            });
    </script>
</body>

</html>