<!DOCTYPE html>
<html>

<head>
  <title>Infinite Asteroids</title>
  <link href="styles.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">









  <!-- #INFINITEGAMES CSS START -->
  <link rel="stylesheet" href="infinite/css/48_leaderboard_20240829095112.css">
  <!-- #INFINITEGAMES CSS END -->
</head>

<body>

  <div id="leftArrow" class="flashing-arrow" style="left: 20px; top: 50%;"></div>
  <div id="rightArrow" class="flashing-arrow" style="right: 20px; top: 50%;"></div>

  <!-- New Leaderboard Modal -->
  <div id="allLeaderboardsModal" class="modal">
    <div class="modal-content">
      <h2>All Game Modes Leaderboard</h2>
      <div id="allLeaderboardsContainer"></div>
      <button id="closeAllLeaderboards">Close</button>
    </div>
  </div>

  <div id="loginPopup" class="modal">
    <div class="modal-content">
      <h2>Login</h2>
      <form id="loginForm">
        <input type="email" id="email" placeholder="Email" required>
        <input type="password" id="password" placeholder="Password" required>
        <button type="submit">Login</button>
      </form>
      <form id="signup-form">
        <h2>Sign Up</h2>
        <input type="text" id="signup-nickname" placeholder="Nickname" required>
        <input type="email" id="signup-email" placeholder="Email" required>
        <input type="password" id="signup-password" placeholder="Password" required>
        <button type="submit">Sign Up</button>
      </form>

    </div>
  </div>

  <!-- Add this somewhere appropriate in your body tag -->
  <div id="upgradeShopModal" class="modal">
    <div class="modal-content">
      <h2>Upgrade Shop</h2>
      <div id="upgrade-shop" class="upgrade-container"></div>
      <button id="closeUpgradeShop">Close Shop</button>
    </div>
  </div>

  <div id="shipCustomizationModal" class="modal">
    <div class="modal-content">
      <h2>Ship Customization</h2>
      <div id="shipPreview"></div>
      <div id="equippedUpgrades" class="upgrade-container">
        <h3>Equipped Upgrades</h3>
        <!-- Equipped upgrades will be added here dynamically -->
      </div>
      <div id="availableUpgrades" class="upgrade-container">
        <h3>Used Upgrades</h3>
        <!-- Available upgrades will be added here dynamically -->
      </div>
      <button id="saveCustomization">Save and Close</button>
    </div>
  </div>


  <div class="top-right" id="loginContainer">
    <a href="#" id="login-link">Login</a>
  </div>

  <div class="top-right hidden" id="userInfo">
    <span id="userNickname"></span> | <a href="#" id="logoutLink">Logout</a>
  </div>


  <div id="xpBarContainer">
    <div id="xpBar"></div>
  </div>

  <!-- ver version -->
  <div id="shipTypeContainer">
    <canvas id="miniShipPreview" width="40" height="40"></canvas>
    <span id="shipType">Customize ship v 0.9585
    </span>
  </div>
  <!-- <div id="shipType">
    Ship type: Basic&nbsp;&nbsp; &nbsp;
  </div> -->


  <div id="technologiesCount">
  </div>
  <!-- 
    <div id="result">

    </div>
  -->
  <div id="levelUpModal" class="modal">
    <div class="modal-content">
      <h2 id="leveluptitle">Level Up!</h2>
      <p>Choose an upgrade:</p>
      <div id="upgradeOptions">
        <div class="upgrade-option" onclick="selectUpgrade(0)">
          <div id="upgradeIcon1" class="upgrade-icon"></div>
          <button id="upgrade1"></button>
        </div>
        <div class="upgrade-option" onclick="selectUpgrade(1)">
          <div id="upgradeIcon2" class="upgrade-icon"></div>
          <button id="upgrade2"></button>
        </div>
        <div class="upgrade-option" onclick="selectUpgrade(2)">
          <div id="upgradeIcon3" class="upgrade-icon"></div>
          <button id="upgrade3"></button>
        </div>
        <div class="upgrade-option" style="display:none" onclick="selectUpgrade(3)">
          <div id="upgradeIcon4" class="upgrade-icon"></div>
          <button id="upgrade4"></button>
        </div>
      </div>
    </div>
  </div>


  <div id="rouletteContainer" style="display: none">
    <div id="rouletteIcons"></div>
    <div id="planet"></div>
    <div id="upgradeDisplay"></div>
    <button id="spinButton" onClick="startRoulette()">Spin [ENTER]</button>

  </div>




  <div id="activeWeaponClassesContainer" class="bottom-icons">
  </div>

  <canvas id="gameCanvas" width="800" height="600"></canvas>

  <div id="bottomContent">
    <div id="waveCounter"></div>
    <div id="coinsDisplay"></div>
    <div id="livesDisplay"></div>
    <div id="controlsInfo"></div>
  </div>



  <div id="endScreen" class="screen">
    <h2>Game Over</h2>
    <p><span id="wave"></span>

    </p>
    <p id="score"></p>
    <p id="asteroidsDestroyed"></p>
    <!-- <p id="bonusCoins"></p> -->

    <h3>Damage Report</h3>
    <ul id="damageReportList"></ul>

    <h3>Recently Unlocked Weapons</h3>
    <ul id="unlockedWeaponsList"></ul>

    <h3>New Achievements</h3>
    <ul id="newAchievementsList"></ul>

    <!-- <h3>Used Upgrades</h3>
      <ul id="upgradesList"></ul> -->
    <p><button id="restartButton">Restart</button></p>

    <div id="leaderboard-container">
      <div id="leaderboard">
        <h2>Leaderboard</h2>
        <ol id="leaderboard-list"></ol>
      </div>
    </div>
  </div>


  <div id="shipSelectionModal" class="modal">
    <div class="modal-content">
      <h2>Customize Your Ship</h2>

      <div class="ship-preview">
        <canvas id="shipPreviewCanvas" width="200" height="200"></canvas>
      </div>

      <div class="selection-section">
        <h3>Select Your Ship</h3>
        <select id="shipSelector">
          <!-- Options will be populated dynamically -->
        </select>
      </div>

      <div class="selection-section">
        <h3>Select Secondary Weapon</h3>
        <select id="secondaryWeaponSelector">
          <!-- Options will be populated dynamically -->
        </select>
      </div>

      <!-- <div class="selection-section">
          <h3>Select Upgrade</h3>
          <select id="upgradeSelector">
          </select>
        </div> -->

      <button id="saveSelections">Save</button>
    </div>
  </div>


  <div id="startScreen">
    <div>
      <img src="icons/ia-logo.png" /> <!--<h2>Welcome to Infinite Asteroids!</h2> -->
      <p>Unlock next level when you reach wave 30.</p>
      <table>

        <tr>
          <th>
            <p>Deep Space</p>
          </th>
          <th>
            <p>Meteor Shower</p>
          </th>
          <th>
            <p>Planet</p>
          </th>
        </tr>
        <tr>
          <td>

            <button id="easyButton" onclick="initializeGame(GameModes.EASY)">Easy</button>
            <button id="normalButton" onclick="initializeGame(GameModes.NORMAL)">Normal</button>
            <button id="hardButton" onclick="initializeGame(GameModes.HARD)" disabled>Hard</button>
            <button id="heroButton" onclick="initializeGame(GameModes.HERO)" disabled>Hero</button>
          </td>
          <td>

            <button id="meteorEasyButton" onclick="initializeGame(GameModes.METEORSHOWEREASY)" disabled>Easy</button>
            <button id="meteorNormalButton" onclick="initializeGame(GameModes.METEORSHOWERNORMAL)"
              disabled>Normal</button>
            <button id="meteorHardButton" onclick="initializeGame(GameModes.METEORSHOWERHARD)" disabled>Hard</button>
            <button id="meteorHeroButton" onclick="initializeGame(GameModes.METEORSHOWERHERO)" disabled>Hero</button>
          </td>
          <td>


            <button id="planetEasyButton" onclick="initializeGame(GameModes.PLANETEASY)" disabled>Easy</button>
            <button id="planetNormalButton" onclick="initializeGame(GameModes.PLANETNORMAL)" disabled>Normal</button>
            <button id="planetHardButton" onclick="initializeGame(GameModes.PLANETHARD)" disabled>Hard</button>
            <button id="planetHeroButton" onclick="initializeGame(GameModes.PLANETHERO)" disabled>Hero</button>
          </td>
        </tr>
        <tr>
          <td>

            <button id="endlessSlowButton" onclick="initializeGame(GameModes.ENDLESS_SLOW)">Endless </button>


          </td>
          <!-- <td>

              <button id="coopButton" onclick="initializeGame(GameModes.COOP)">Co-op </button>


            </td>
  -->
        </tr>

        </tr>

      </table>

      <div id="achievementsContainer">

        <h3>Your Achievements</h3>
        <div id="achievementsList"></div>
      </div>
      <!-- <h3>Your Upgrades</h3> -->
      <div id="upgradesList"></div>
      <button id="viewAllLeaderboardsButton">View All Leaderboards</button>


      <!-- <button onclick="initializeGame(GameModes.NORMAL)" ${!modesUnlocked.normal ? 'disabled' : '' }>Normal</button>
        <button onclick="initializeGame(GameModes.HARD)" ${!modesUnlocked.hard ? 'disabled' : '' }>Hard</button> -->
      <!-- <p>Tap lower left for store.</p> -->
      <!-- <p>Tap with two fingers to fire.</p> -->
      <!-- <button onclick="startGame()">Start Game</button> -->
    </div>
  </div>

  <div id="joystick">
    <div id="joystickHandle"></div>

  </div>

  <div id="weaponInfo">
    <h2>Weapon Information</h2>
    <div id="weaponsContainer">
      <!-- Weapon entries will be dynamically added here -->
    </div>
    <div id="secondaryWeaponInfo"></div>


    <button id="closeButton" onclick="toggleWeaponInfo()">Close</button>
  </div>

  <div id="volumeScreen" style="display:none;">

    <h2>Settings</h2>

    <h3>Volume Control</h3>
    <input type="range" id="volumeSlider" min="1" max="10" value="5">
    <p>Volume: <span id="volumeValue">5</span></p>
    <h3>Toggle redeem mode</h3>
    <p>In redeem mode you push "r" to use your upgrade credits instead of them appearing automatically</p>
    <p>Status: <span id="redeemModeStatus">Off</span></p>

    <button id="toggleReedem" onClick="toggleRedeemMode()">Toggle</button>
    <p>
      <button id="toggleMusic" onClick="toggleMusic()">Toggle Music (or push "M")</button>

      <button id="toggleSound" onClick="toggleSound()">Toggle Sound (or push "N")</button>
    </p>

    <button onclick="toggleVolumeScreen()">Close</button>
  </div>



  <audio id="background-music" src="sounds/music_loop.mp3" loop></audio>

  <audio id="meteor-destroy-1" src="sounds/meteor_destroy.mp3"></audio>
  <audio id="meteor-destroy-2" src="sounds/meteor_destroy2.mp3"></audio>
  <audio id="meteor-destroy-3" src="sounds/meteor_destroy3.mp3"></audio>

  <audio id="shot-sound-1" src="sounds/shot1.mp3"></audio>
  <audio id="shot-sound-2" src="sounds/shot2.mp3"></audio>
  <audio id="shot-sound-3" src="sounds/shot3.mp3"></audio>

  <audio id="thruster-sound-1" src="sounds/thruster1.mp3"></audio>
  <audio id="thruster-sound-2" src="sounds/thruster2.mp3"></audio>
  <audio id="thruster-sound-3" src="sounds/thruster3.mp3"></audio>

  <audio id="ship-destroyed" src="sounds/ship_destroyed.mp3"></audio>

  <audio id="alien-entering-sound" src="sounds/alien_entering.mp3"></audio>

  <audio id="alien-laser-1" src="sounds/alien_laser1.mp3"></audio>
  <audio id="alien-laser-2" src="sounds/alien_laser2.mp3"></audio>
  <audio id="alien-laser-3" src="sounds/alien_laser3.mp3"></audio>

  <audio id="gem-collecting-sound" src="sounds/bird_chirp.mp3"></audio>

  <audio id="freeze-sound" src="sounds/freeze.mp3"></audio>
  <audio id="freeze-sound-2" src="sounds/freezew.mp3"></audio>
  <audio id="death-ray-sound" src="sounds/dray1.mp3"></audio>
  <audio id="deploy-drone-sound" src="sounds/deploy_drone.mp3"></audio>
  <audio id="acid-bomb-sound" src="sounds/acid_bomb.mp3"></audio>
  <audio id="bomb-lay-sound" src="sounds/lay_bomb.mp3"></audio>
  <audio id="lightning-sound" src="sounds/lightning_echo.mp3"></audio>
  <audio id="flamethrower" src="sounds/flamethrow.mp3"></audio>

  <audio id="megaboss-background-music" src="sounds/boss1.mp3" loop></audio>
  <audio id="supermegaboss-background-music" src="sounds/boss2.mp3" loop></audio>
  <audio id="octo-background-music" src="sounds/boss3.mp3" loop></audio>


  <!-- <button id="restartButton" style="display: none;">Home</button> -->
  <script>

    const canvas = document.getElementById('gameCanvas');
    let ctx = canvas.getContext('2d');

  </script>



  <script>
    // Get the canvas element



    // Event listeners for keyboard input




    document.addEventListener('DOMContentLoaded', () => {

      updateMiniShipPreview();
      // loadAchievements();
      // populateAchievements();
      if (isMobile()) {
        document.getElementById('joystick').style.display = 'block';
        document.getElementById('startScreen').style.display = 'flex';
      } else {
        // startGame();
      }
    });


    document.getElementById('viewAllLeaderboardsButton').addEventListener('click', async () => {
      const allLeaderboardsContainer = document.getElementById('allLeaderboardsContainer');
      allLeaderboardsContainer.innerHTML = ''; // Clear previous content

      const allScores = await loadAllLeaderboards(gameId); // Replace 'YourGameName' with your actual game name

      for (let mode in allScores) {
        const leaderboardDiv = document.createElement('div');
        leaderboardDiv.className = 'leaderboard-mode';
        leaderboardDiv.innerHTML = `<p>&nbsp;</p><h3>${mode}</h3>`;

        allScores[mode].forEach((entry, index) => {
          const formattedScore = entry.score.toLocaleString('en-US', {
            maximumFractionDigits: 0
          });
          leaderboardDiv.innerHTML += `<p>${index + 1}. ${entry.nickname}: ${formattedScore} points</p>`;
        });

        allLeaderboardsContainer.appendChild(leaderboardDiv);
      }

      document.getElementById('allLeaderboardsModal').style.display = 'block';
    });

    document.getElementById('closeAllLeaderboards').addEventListener('click', () => {
      document.getElementById('allLeaderboardsModal').style.display = 'none';
    });










    function updateCoinsDisplay() {
      coinsDisplay.textContent = coins;
    }



    function drawPixelatedExplosion(x, y, size) {
      const canvas = document.createElement('canvas');
      // const ctx = canvas.getContext('2d');
      const pixelSize = 4; // Adjust pixel size to your preference

      canvas.width = size;
      canvas.height = size;

      // Draw explosion on the off-screen canvas
      ctx.fillStyle = 'orange';
      ctx.beginPath();
      ctx.arc(size / 2, size / 2, size / 2, 0, Math.PI * 2);
      ctx.fill();

      // Get the image data
      const imageData = ctx.getImageData(0, 0, size, size);

      // Create a new canvas for pixelated effect
      const pixelCanvas = document.createElement('canvas');
      const pixelCtx = pixelCanvas.getContext('2d');

      pixelCanvas.width = size;
      pixelCanvas.height = size;

      // Draw pixelated effect
      for (let y = 0; y < size; y += pixelSize) {
        for (let x = 0; x < size; x += pixelSize) {
          const pixelIndex = (y * size + x) * 4;
          const r = imageData.data[pixelIndex];
          const g = imageData.data[pixelIndex + 1];
          const b = imageData.data[pixelIndex + 2];
          const a = imageData.data[pixelIndex + 3];

          pixelCtx.fillStyle = `rgba(${r}, ${g}, ${b}, ${a / 255})`;
          pixelCtx.fillRect(x, y, pixelSize, pixelSize);
        }
      }

      // Draw the pixelated explosion on the main canvas
      ctx.drawImage(pixelCanvas, 0, 0);

      // Draw the pixelated canvas onto the game canvas
      ctx.drawImage(canvas, x - size / 2, y - size / 2);
    }

    // Usage
    // drawPixelatedExplosion(100, 100, 64);





    function showArrow(side) {
      const leftArrow = document.getElementById('leftArrow');
      const rightArrow = document.getElementById('rightArrow');

      if (side === 'left') {
        leftArrow.style.display = 'block';
        rightArrow.style.display = 'none';
      } else {
        leftArrow.style.display = 'none';
        rightArrow.style.display = 'block';
      }

      setTimeout(() => {
        leftArrow.style.display = 'none';
        rightArrow.style.display = 'none';
        createAsteroids(side);
      }, 700);
    }





    joystick.addEventListener('touchstart', (e) => {
      isTouchingJoystick = true;
      joystickStartX = e.touches[0].clientX;
      joystickStartY = e.touches[0].clientY;
    });


    joystick.addEventListener('touchmove', (e) => {
      if (isTouchingJoystick) {
        const touchX = e.touches[0].clientX;
        const touchY = e.touches[0].clientY;
        const deltaX = touchX - joystickStartX;
        const deltaY = touchY - joystickStartY;

        // Calculate angle and distance from the center
        const angle = Math.atan2(deltaY, deltaX);
        const distance = Math.min(Math.sqrt(deltaX * deltaX + deltaY * deltaY), 50); // Limit the joystick handle movement

        // Update joystick handle position
        joystickHandle.style.transform = `translate(${distance * Math.cos(angle)}px, ${distance * Math.sin(angle)}px)`;

        // Update ship rotation and speed based on joystick movement
        ship.rotation = angle * (180 / Math.PI); // Convert radians to degrees
        ship.speed = Math.min(distance / 20, ship.maxSpeed); // Adjust speed based on distance, ensure it doesn't exceed maxSpeed

        e.preventDefault();
      }
    });

    joystick.addEventListener('touchend', () => {
      isTouchingJoystick = false;
      ship.speed = 0;
      joystickHandle.style.transform = 'translate(-50%, -50%)'; // Reset joystick handle position
    });

    restartButton.addEventListener('click', () => {
      // restartButton.style.display = 'none';
      document.getElementById('endScreen').style.display = 'none';
      startScreen.style.display = 'block';

      resetShip();
      gravityStrength = 0;
      meteorMode = false;
      planetMode = false;
      fourthUpgradeUnlocked = false;
      doubleTurret = false;
      tripleTurret = false;
      droneArmy = false;
      alienLasers = [];
      alienLaser = null;
      activeMegaUpgrades = [];
      ship.lasers = [];
      lastRareAsteroids = [];

      flamethrower = {
        cooldown: 10, // Cooldown time in frames
        timer: 0, // Current cooldown timer
        range: 100, // Range of the flamethrower
        damage: 1, // Damage dealt per frame
        active: false, // Flag to track if the flamethrower is active
        damagePerSecond: 1 // Damage dealt per second
      };

      flamethrowerUpgrades = {
        range: 1,
        damage: 1,
        cooldown: 1
      };


      turret = {
        x: 0,
        y: 0,
        size: 10,
        rotationSpeed: 2,
        fireInterval: 120,
        fireTimer: 0,
        range: 400,
        damage: 3,
        color: 'cyan',
        lasers: [] // Initialize the turret's lasers array
      };

      let count = countTechnologies();
      const technologiesCountElement = document.getElementById('technologiesCount');
      technologiesCountElement.textContent = `You have unlocked ${count} of 42 technologies`;
      document.getElementById('technologiesCount').style.display = 'block';
      document.getElementById('shipType').style.display = 'block';

      lives = 3;
      score = 0;
      wave = 1;
      asteroidsKilled = 0;
      aliensKilled = 0;

      // Reset coins and XP
      coins = 0;
      level = 1;
      xpToNextLevel = 300;
      xp = 0;
      updateXPBar();

      // Reset asteroids and drones
      asteroids = [];
      drones = [];
      aliens = [];
      alien = null;
      swarmingAliens = [];
      superbossAlien = null;
      megaBossAlien = null;
      alienLasers = [];
      droppedGems = [];

      // Reset turret upgrades
      turret.bought = false;
      // Reset active weapon classes
      activeWeaponClasses = [];


      level = 1;
      xp = 0;

      acidBomb = {
        cooldown: 300,
        timer: 0,
        duration: 300, // Duration the acid effect lasts (5 seconds at 60 FPS)
        damagePerSecond: 1,
        size: 50,
        activeBombs: [],
        activeAreas: []
      };

      acidBombUpgrades = {
        duration: 1,
        cooldown: 1,
        size: 1
      };

      boomerang = {
        x: canvas.width / 2,
        y: canvas.height / 2,
        size: 10,
        speed: 2,
        damage: 1,
        dx: 3,
        dy: 3,
        active: false
      };

      boomerangUpgrades = {
        speed: 1,
        damage: 1
      };

      nanoswarm = {
        cooldown: 300,
        timer: 0,
        speed: 2,
        damage: 5,
        activeMissiles: []
      };

      nanoswarmUpgrades = {
        speed: 1,
        damage: 1,
        cooldown: 1
      };

      freezeEffect = {
        cooldown: 600, // Cooldown period for freeze effect (10 seconds at 60 FPS)
        timer: 0,
        duration: 300, // Duration the freeze effect lasts (5 seconds at 60 FPS)
        active: false,
        remainingDuration: 0
      };

      freezeEffectUpgrades = {
        duration: 1,
        cooldown: 1
      };

      damageReport = {
        lasers: 0,
        explosive: 0,
        drones: 0,
        turret: 0,
        sonicBlast: 0,
        bomberDrones: 0,
        deathRay: 0,
        acid: 0,
        freeze: 0,
        boomerang: 0,
        nano: 0

      };


      deathRay = {
        length: 1000,
        width: 40,
        cooldown: 300,
        timer: 0
      };


      deathRayActive = false;

      deathRayUpgrades = {
        length: 1,
        width: 1,
        cooldown: 1
      };



      ship = {
        x: canvas.width / 2,
        y: canvas.height - 50,
        size: 20,
        speed: 0,
        acceleration: 0.15,
        deceleration: 0.96,
        maxSpeed: 3,
        rotation: 0,
        rotationSpeed: 1.7,
        lasers: [],
        velocityX: 0,
        velocityY: 0,
        laserLevel: 2,
        weaponSlots: 5,
        upgradeSlots: 2,
        accelerationLevel: 1,
        rotationSpeedLevel: 1,
        maxBulletsLevel: 1,
        explosiveLaserLevel: 0,
        laserCooldown: 30,
        laserTimer: 0,
        laserCooldownLevel: 1,

      };

      drone = {
        x: canvas.width / 2,
        y: canvas.height / 2,
        size: 10,
        speed: 0.0001,
        direction: Math.random() * Math.PI * 2,
        lasers: [],
        laserSpeed: 3,
        laserInterval: 80, // Fire lasers every 120 frames (2 second)
        laserTimer: 0
      };

      turret = {
        x: 0,
        y: 0,
        size: 10,
        rotationSpeed: 2,
        fireInterval: 120,
        fireTimer: 0,
        range: 400,
        damage: 3,
        color: 'cyan',
        lasers: [] // Initialize the turret's lasers array
      };

      turretUpgrades = {
        range: 1,
        fireRate: 1,
        damage: 1
      };

      sonicBlast = {
        cooldown: 300, // Cooldown time in frames (5 seconds at 60 FPS)
        timer: 0, // Current cooldown timer
        range: 120, // Range of the sonic blast
        speed: 2, // Speed of the sonic blast wave
        damage: 1, // Damage dealt by the sonic blast
        waves: [], // Array to store the active sonic blast waves
        rangeLevel: 1,
        damageLevel: 1,
        cooldownLevel: 1

      };

      // Reset game state
      gameOver = false;
      invincible = true;
      invincibilityTimer = invincibilityDuration;
      // document.getElementById('leaderboard-container').style.display = 'none';

      // Reset spawn variables
      spawnTimer = spawnCooldown;
      chanceForSmallAsteroid = 3;
      chanceForVerySmallAsteroid = 1;
      chanceForHardenedAsteroid = 5;
      chanceForVeryHardenedAsteroid = 2;

      // Reset ship position
      // resetShip();

      bomberDrones = [];


      // bomberDrones = [];
      bomberDroneUpgrades = {
        speed: 1,
        bombRadiusLevel: 1,
        bombRadius: 50,
        bombDamage: 2
      };

      chainLightning = {
        cooldown: 300, // Cooldown time in frames
        timer: 0, // Current cooldown timer
        range: 200, // Range of the chain lightning
        damage: 5, // Damage dealt per hit
        bounces: 2, // Number of bounces
        active: false // Flag to track if the chain lightning is active
      };

      chainLightningUpgrades = {
        range: 1,
        damage: 1,
        bounces: 1,
        cooldown: 1
      };


      // Start a new game
      // createAsteroids();
      // startGame();
    });







    function toggleWeaponInfo() {
      const weaponInfoDiv = document.getElementById('weaponInfo');

      // console.log(weaponInfoDiv);
      weaponInfoDiv.style.display = weaponInfoDiv.style.display === 'none' ? 'block' : 'none';
      // console.log("toggle2");
      if (weaponInfoDiv.style.display === 'none') {
        clearInterval(gameLoop);
        gameLoop = setInterval(update, 1000 / 60);
      } else {
        clearInterval(gameLoop);

      }

      // Won't place nicely together with above
      // if (isPaused) {

      //   gameLoop = setInterval(update, 1000 / 60); // Resume game loop
      //   isPaused = false;

      // } else {

      //   clearInterval(gameLoop);
      //   isPaused = true;

      // }


    }

    function loadWeaponInfo() {
      const weaponsContainer = document.getElementById('weaponsContainer');
      weaponsContainer.innerHTML = '';
      for (let i = 0; i < weapons.length; i += 2) {
        const row = document.createElement('div');
        row.className = 'weapon-row';

        for (let j = i; j < i + 2 && j < weapons.length; j++) {
          const weapon = weapons[j];
          const weaponDiv = document.createElement('div');
          weaponDiv.className = 'weapon';

          weaponDiv.innerHTML = `
                <div class="weapon-icon ${weapon.icon}"></div>
                <div class="weapon-info">
                    <h3>${weapon.name}</h3>
                    <p>${weapon.description}</p>
                </div>
            `;

          row.appendChild(weaponDiv);
        }

        weaponsContainer.appendChild(row);
      }
    }

    function populateUpgrades() {
      const upgradesList = document.getElementById('upgradesList');
      upgradesList.innerHTML = '';

      megaUpgrades.forEach(upgrade => {
        const upgradeElement = document.createElement('div');
        upgradeElement.classList.add('upgrade');
        upgradeElement.style.opacity = upgrade.owned ? '1' : '0.5';

        const icon = document.createElement('img');
        icon.classList.add('upgrade-icon');
        icon.src = upgrade.icon;
        icon.alt = upgrade.name;
        upgradeElement.appendChild(icon);

        const description = document.createElement('span');
        description.classList.add('upgrade-info');

        description.textContent = upgrade.description;
        upgradeElement.appendChild(description);

        upgradesList.appendChild(upgradeElement);
      });
    }


    window.onload = loadWeaponInfo;







  </script>
  <script src="js/ships.js"></script>

  <script src="js/game.js"></script>


  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
  <script>

    let userId = "";
    const firebaseConfig = {
      apiKey: "AIzaSyCvgdn8c6D8RusKRr4vHAzFj1x4FNxrXVE",
      authDomain: "infinite-games-9c69e.firebaseapp.com",
      projectId: "infinite-games-9c69e",
      storageBucket: "infinite-games-9c69e.appspot.com",
      messagingSenderId: "602022483888",
      appId: "1:602022483888:web:f967a6c1cb236ae66ba875",
      measurementId: "G-9LE6E1BKZ7"
    };


  </script>
  <script type="module">

    // import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    // import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js";
    // import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js";
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    // import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getFirestore, doc, updateDoc, arrayUnion, getDoc, setDoc, getDocs, collection } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";


    // Firebase configuration and initialization
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const auth = getAuth(app);
    const db = getFirestore(app);







    const loginLink = document.getElementById('login-link');
    const loginPopup = document.getElementById('loginPopup');
    const loginForm = document.getElementById('loginForm');
    const userInfo = document.getElementById('userInfo');
    const userNickname = document.getElementById('userNickname');
    const logoutLink = document.getElementById('logoutLink');
    const loginContainer = document.getElementById('loginContainer');
    const signupForm = document.getElementById('signup-form');


    async function saveInitialData(userId, email, nickname) {
      const initialData = {
        email: email,
        nickname: nickname,
        coins: 100,
        portfolio: {},
        portfolioHistory: []
      };
      await setDoc(doc(db, 'users', userId), initialData);
    }

    loginLink.addEventListener('click', (event) => {
      loginFormOpen = true;
      event.preventDefault();
      pauseGame();
      loginPopup.style.display = 'block';
    });

    loginForm.addEventListener('submit', (event) => {
      event.preventDefault();
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;

      signInWithEmailAndPassword(auth, email, password)
        .then((userCredential) => {
          const user = userCredential.user;
          loadUserData(user.uid);
          loginPopup.style.display = 'none';
          loginFormOpen = false;
          resumeGame();
        })
        .catch((error) => {
          console.error('Error signing in:', error.message);
        });
    });

    signupForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = signupForm['signup-email'].value;
      const password = signupForm['signup-password'].value;
      const nickname = signupForm['signup-nickname'].value;
      try {
        const cred = await createUserWithEmailAndPassword(auth, email, password);
        userId = cred.user.uid;
        await saveInitialData(userId, email, nickname);
        signupForm.reset();
        // document.getElementById('auth').classList.toggle('hidden');
        loginPopup.style.display = 'none';
        loginFormOpen = false;

      } catch (error) {
        console.error("Error creating user:", error.message);
      }
    });

    logoutLink.addEventListener('click', (event) => {
      event.preventDefault();
      auth.signOut()
        .then(() => {
          userInfo.style.display = 'none';
          loginLink.style.display = 'block';
        })
        .catch((error) => {
          console.error('Error signing out:', error);
        });
    });


    auth.onAuthStateChanged(user => {
      if (user) {
        loadUserData(user.uid);
        userId = user.uid;
        if (score && score > 1000) {


          const gameData = {
            score: score
          };
          saveUserScore(userId, gameId, gameData);
        }



      } else {
        userInfo.style.display = 'none';
        loginContainer.style.display = 'block';

        pauseGame();
      }
    });


    async function loadUserData(userId) {
      try {
        const userDoc = await getDoc(doc(db, 'users', userId));

        if (userDoc.exists()) {
          const userData = userDoc.data();
          userNickname.textContent = userData.nickname;
          userInfo.style.display = 'block';
          loginLink.style.display = 'none';

          const gameAchievements = userData.games?.[gameId]?.achievements || {};
          Object.assign(Achievements, gameAchievements);

          // const gameUpgrades = userData.games?.[gameId]?.megaUpgrades || {};
          // Object.assign(megaUpgrades, gameUpgrades);

          populateAchievements();
          // populateUpgrades();
        } else {
          console.log("No such document!");
        }
      } catch (error) {
        console.error("Error getting user data:", error);
      }
    }


    // document.getElementById('login-toggle').addEventListener('click', function (event) {
    //   event.preventDefault();
    //   document.getElementById('auth').classList.toggle('hidden');
    // });

    // Function to save user score for a specific game
    async function saveUserScore(userId, gameName, gameData) {
      const db = getFirestore();
      const userDocRef = doc(db, 'users', userId);
      const loginTime = new Date();
      const sessionLength = loginTime - gameStartTime;

      if (typeof gameData === 'undefined' || typeof sessionLength === 'undefined') {
        console.error('Invalid game data or session length');
        return;
      }

      const userDoc = await getDoc(userDocRef);
      if (userDoc.exists()) {
        const userData = userDoc.data();
        const existingAchievements = userData.games?.[gameName]?.achievements || {};

        const activeMegaUpgradeNames = activeMegaUpgrades.map(upgrade => upgrade.name);

        const updatedAchievements = { ...existingAchievements, ...Achievements };

        //FirebaseError: Function arrayUnion() called with invalid data. Unsupported field value: undefined (found in document users/fpm9uNmvYeb9HKnZ32juQTmyxzj2)
        // usedUpgrades: activeMegaUpgradeNames

        const fullGameData = {
          [`games.${gameName}.scores`]: arrayUnion({
            score: gameData.score,
            topWeapons: gameData.topWeapons,
            sessionLength: sessionLength,
            loginTime: loginTime,
            fpsDrops: halfFPSCount,
            gameMode: currentMode
            // Add the game mode to the saved data
          }),
          [`games.${gameName}.achievements`]: updatedAchievements,
        };

        await updateDoc(userDocRef, fullGameData);
      } else {
        const gameData = {
          [`games.${gameName}.scores`]: [
            {
              score: score,
              sessionLength: sessionLength,
              loginTime: loginTime,
              gameMode: currentMode  // Add the game mode to the saved data
            }
          ],
          [`games.${gameName}.achievements`]: Achievements,
        };

        await setDoc(userDocRef, gameData);
      }
    }

    window.saveUserScore = saveUserScore;

    // Function to save initial user data
    async function saveUserData(userId, gameName) {
      const db = getFirestore();
      const userDocRef = doc(db, 'users', userId);
      const userData = {
        [`games.${gameName} `]: {
          scores: [],
          lastLogin: new Date()
        }
      };
      await setDoc(userDocRef, userData, { merge: true });
    }

    window.saveUserData = saveUserData;


    async function loadLeaderboard(gameName, gameMode) {
      const db = getFirestore();
      const usersSnapshot = await getDocs(collection(db, 'users'));
      const scores = [];

      usersSnapshot.forEach(doc => {
        const userData = doc.data();
        const gameScores = userData.games?.[gameName]?.scores || [];
        gameScores.forEach(session => {
          if (session.score && isFinite(session.score) && session.score <= 100000000 && session.gameMode === gameMode) {
            scores.push({
              nickname: userData.nickname || 'Unnamed',
              score: session.score,
              wave: session.wave  // Assuming we also save the wave number
            });
          }
        });
      });



      scores.sort((a, b) => b.score - a.score);

      const limitedScores = [];
      const playerCounts = {};

      scores.forEach(score => {
        if (!playerCounts[score.nickname]) {
          playerCounts[score.nickname] = 0;
        }
        if (playerCounts[score.nickname] < 3) {
          limitedScores.push(score);
          playerCounts[score.nickname]++;
        }
      });

      const topScores = limitedScores.slice(0, 12);

      const leaderboard = document.getElementById('leaderboard');
      leaderboard.innerHTML = `<h2>Leaderboard - ${getGameModeName(gameMode)}</h2>`;
      topScores.forEach((entry, index) => {
        const formattedScore = entry.score.toLocaleString('en-US', {
          maximumFractionDigits: 0
        });
        const scoreDiv = document.createElement('div');
        scoreDiv.innerText = `${index + 1}. ${entry.nickname}: ${formattedScore} points`;
        leaderboard.appendChild(scoreDiv);
      });

      document.getElementById('leaderboard-container').appendChild(leaderboard);
    }

    async function loadAllLeaderboards(gameName) {
      const db = getFirestore();
      const usersSnapshot = await getDocs(collection(db, 'users'));
      const allScores = {};

      const gameModes = [
        { id: GameModes.EASY, name: "Easy" },
        { id: GameModes.NORMAL, name: "Normal" },
        { id: GameModes.HARD, name: "Hard" },
        { id: GameModes.HERO, name: "Hero" },
        { id: GameModes.METEORSHOWEREASY, name: "Meteor Shower Easy" },
        { id: GameModes.METEORSHOWERNORMAL, name: "Meteor Shower Normal" },
        { id: GameModes.METEORSHOWERHARD, name: "Meteor Shower Hard" },
        { id: GameModes.METEORSHOWERHERO, name: "Meteor Shower Hero" },
        { id: GameModes.PLANETEASY, name: "Planet Easy" },
        { id: GameModes.PLANETNORMAL, name: "Planet Normal" },
        { id: GameModes.PLANETHARD, name: "Planet Hard" },
        { id: GameModes.PLANETHERO, name: "Planet Hero" },
        { id: GameModes.ENDLESS_SLOW, name: "Endless Slow" }
      ];

      usersSnapshot.forEach(doc => {
        const userData = doc.data();
        gameModes.forEach(mode => {
          const gameScores = userData.games?.[gameName]?.scores || [];
          gameScores.forEach(session => {
            if (session.score && isFinite(session.score) && session.score <= 100000000 && session.gameMode === mode.id) {
              if (!allScores[mode.name]) {
                allScores[mode.name] = [];
              }
              allScores[mode.name].push({
                nickname: userData.nickname || 'Unnamed',
                score: session.score,
                wave: session.wave  // Assuming we also save the wave number
              });
            }
          });
        });
      });

      // Sort and limit scores for each mode
      for (let mode in allScores) {
        allScores[mode].sort((a, b) => b.score - a.score);

        const playerCounts = {};
        allScores[mode] = allScores[mode].filter(score => {
          if (!playerCounts[score.nickname]) {
            playerCounts[score.nickname] = 0;
          }
          if (playerCounts[score.nickname] < 3) {
            playerCounts[score.nickname]++;
            return true;
          }
          return false;
        }).slice(0, 12);
      }

      return allScores;
    }


    function getGameModeName(mode) {
      switch (mode) {
        case GameModes.EASY: return "Easy";
        case GameModes.NORMAL: return "Normal";
        case GameModes.HARD: return "Hard";
        case GameModes.HERO: return "Hero";
        case GameModes.METEORSHOWEREASY: return "Meteor Shower Easy";
        case GameModes.METEORSHOWERNORMAL: return "Meteor Shower Normal";
        case GameModes.METEORSHOWERHARD: return "Meteor Shower Hard";
        case GameModes.METEORSHOWERHERO: return "Meteor Shower Hero";
        case GameModes.PLANETEASY: return "Planet Easy";
        case GameModes.PLANETNORMAL: return "Planet Normal";
        case GameModes.PLANETHARD: return "Planet Hard";
        case GameModes.PLANETHERO: return "Planet Hero";
        case GameModes.ENDLESS_SLOW: return "Endless Slow";
        default: return "Unknown Mode";
      }
    }

    window.loadLeaderboard = loadLeaderboard;
    window.loadAllLeaderboards = loadAllLeaderboards;


    // Function to load achievements from Firebase or localStorage
    async function loadAchievements() {
      const params = new URLSearchParams(window.location.search);
      const userId = params.get('userId');
      const db = getFirestore();
      let loadedAchievements = {};

      if (userId) {
        const userDocRef = doc(db, 'users', userId);
        const userDoc = await getDoc(userDocRef);

        if (userDoc.exists() && userDoc.data().achievements) {
          loadedAchievements = userDoc.data().achievements;
          console.log('loadach');

        } else {
          const savedAchievements = localStorage.getItem('achievements');
          if (savedAchievements) {
            loadedAchievements = JSON.parse(savedAchievements);
          }
        }
      } else {
        const savedAchievements = localStorage.getItem('achievements');
        if (savedAchievements) {
          loadedAchievements = JSON.parse(savedAchievements);
        }
      }
      Object.assign(Achievements, loadedAchievements);

      return Achievements;
    }

    window.loadAchievements = loadAchievements;

  </script>












  <script src="js/optimize.js"></script>
  <script src="js/audio.js"></script>


  <!-- <script src="infinite/leaderboard.js"></script> -->
  <script src="js/asteroids.js"></script>
  <script src="js/weapons.js"></script>
  <script src="js/weapons-secondary.js"></script>
  <script src="js/weapons-optimized.js"></script>
  <script src="js/upgrade-menu.js"></script>
  <script src="js/upgrades-functions.js"></script>
  <script src="js/upgrades-main.js"></script>

  <script src="js/aliens.js"></script>
  <script src="js/gems.js"></script>
  <script src="js/special-effects.js"></script>


  <!-- <div id="auth" class="hidden">
      <h1>Infinite Games</h1>
      <h2>Login</h2>
      <form id="login-form">
        <input type="email" id="email" placeholder="Email" required>
        <input type="password" id="password" placeholder="Password" required>
        <button type="submit">Login</button>
      </form>
    </div> -->














  <!-- #INFINITEGAMES JS START -->
  <script src="infinite/js/48_leaderboard_20240829095112.js"></script>
  <script src="infinite/js/48_firebase_20240829095112.js"></script>
  <!-- #INFINITEGAMES JS END -->
</body>

</html>